sub <- rep(1:89,rep(9,89))
x <- rep(c(1:6,8,10,12),89)
y <- scan(,n=9*89)
2.7  0.4  0.0  0.5  0.6  0.0  0.0  0.5  0.8
4.5  5.5  3.9  2.7  2.9  2.0  1.5  1.3  1.7
7.0  9.2 13.1 12.1 12.3 10.3  8.5  6.2  3.8 
4.4  6.1  8.8  7.4  6.8  6.2  5.5  4.9  3.3
4.0  7.7  7.5 10.3 10.6  9.3  7.3  5.8  6.4 
6.5  7.4  5.3  4.5  2.9  3.3  3.0  3.2  3.4
3.2  2.3  0.9  0.2  0.0  0.0  0.6  0.5  0.0
6.2  7.7  5.9  4.1  4.5  2.4  2.0  1.5  0.9
3.0  4.5  8.0  8.1  8.6  7.4  6.8  5.5  4.9
2.0  2.4  2.9  2.3  1.9  2.1  2.0  1.2  0.1
6.2  8.1 10.9  8.0  5.4  6.4  5.0  3.5  3.4
4.6  6.3  5.8  4.6  4.6  3.0  3.0  3.0  2.5
4.5  7.5  8.0 10.6 10.9 11.0  8.1  7.2  4.3
6.6  9.1  7.7  8.4  8.1  7.6  3.9  3.5  1.9
2.8  4.3  3.3  2.3  1.0  1.6  1.6  1.5  1.4
4.0  5.0  4.2  3.9  2.1  2.2  2.1  2.2  2.1
2.8  3.8  0.0  0.0  0.0  0.0  0.0  0.0  0.0 
6.0  8.1  3.8  2.7  1.7  1.7  1.4  0.0  1.1
2.4  4.5  4.7  5.3  4.5  3.5  3.3  3.0  4.0
5.4  5.7  3.7  3.0  2.0  0.0  0.0  0.0  0.0
3.1  4.3  3.8  4.3  2.8  2.1  1.6  1.3  1.8
5.4  6.9  6.9  5.5  6.2  6.2  3.6  3.4  3.8
0.0  0.0  0.0  0.0  0.0  1.0  0.0  0.5  0.5
4.6  4.1  5.1  3.5  4.0  3.4  1.9  2.9  1.3
5.9  7.9 10.1  9.8 10.7 11.2 10.6  9.7  9.2
5.5  6.4  8.6  8.1  6.4  6.3  6.5  7.0  7.2
2.4  5.3  2.4  1.7  1.6  0.3  0.1  0.0  0.0
2.2  1.7  1.2  1.3  0.3  1.5  1.0  0.2  0.2
2.9  2.5  1.2  1.1  1.3  1.3  1.3  0.0  0.0 
5.5  7.8  9.2  8.3  8.2  6.5  5.4  5.4  5.6
3.5  4.6  4.4  4.5  3.2  3.0  1.7  1.0  0.0
4.2  4.5  1.8  0.7  0.2  1.1  0.6  0.5  0.1
6.3  7.8  9.9  6.1  5.3  3.0  3.7  3.5  4.0
4.6  1.1  0.7  1.8  1.1  1.0  1.0  1.2  1.6
3.6  7.3  7.2  6.0  4.8  4.4  3.6  3.4  3.1
2.6  3.8  3.5  1.9  1.2  0.7  0.7  0.9  1.4
2.9  4.4  7.3  8.3  8.7  7.6  8.0  7.8  6.8
5.0  9.2  9.6 12.3  9.8 12.2  8.6  8.4  7.4
4.5  7.0  8.7 10.5 10.3  7.4  7.9  7.5  6.8
6.6  7.7 10.4  9.3  9.8 11.7 10.8  8.8  9.0
4.9  9.7 11.2 11.0  8.6  7.7  5.5  4.8  5.0
2.3  2.2  2.0  2.9  2.7  2.0  1.4  1.1  0.2
0.6  0.2  0.0  0.2  0.0  0.0  0.0  0.4  0.0
3.5  5.2  7.4  9.4  7.2  7.0  4.8  4.0  2.1
5.0  8.9  8.8  9.4 10.3 10.4 11.8 11.3 10.6
7.3  9.7 12.3 10.9 13.7 13.1 12.1 13.6 10.2
7.0  9.0  9.6 10.0 10.3 10.1  8.7  7.9  6.8
6.5  6.6  8.0  4.4  3.4  3.3  1.4  2.0  1.2
5.4  7.3  7.8  8.6  9.1  9.0  9.7  6.3  6.0
3.5  5.0  4.8  4.5  3.5  3.5  3.6  3.0  2.8
0.0  0.8  0.0  0.0  0.2  0.1  0.4  0.5  0.6
1.5  4.8  4.1  5.0  4.1  3.5  2.1  3.5  3.3
3.9  2.9  1.5  1.0  1.5  1.1  0.7  0.5  0.1
0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
2.8  2.2  1.5  1.2  0.9  0.3  0.5  0.0  0.2
6.2  6.8  4.6  3.5  2.4  3.1  2.7  3.0  3.5
5.9 10.0  8.6  9.3 10.5  8.9 10.0  9.7  7.2
8.8  9.9  7.5 11.0  7.3  5.0  5.1  4.0  2.9
5.4  8.2  8.0  8.2  6.7  4.6  3.2  2.7  4.0
5.1  6.0  2.7  1.0  0.8  0.5  0.4  0.5  0.5
4.1  9.1 10.5 12.8 14.8 11.8 13.5 11.2  7.3
8.0 10.2  9.4  7.6  5.7  2.9  3.0  3.4  2.0
4.0  6.5  7.8  8.6  5.5  6.7  3.8  2.2  1.2
6.3  5.6  5.5  4.6  3.2  0.9  1.4  1.2  1.2
1.4  1.3  0.2  0.0  0.3  0.4  0.6  0.8  1.0
3.6  7.3  7.3  8.0  4.2  5.0  2.8  2.5  2.0 
2.6  3.4  1.3  0.5  1.5  1.0  0.2  0.5  1.1
6.7 11.4 14.6 14.1 13.6  9.6  9.0  7.8  3.9
2.6  8.6  9.0  9.8  9.6  8.6  6.2  5.9  5.5
4.0  6.1  5.6  3.7  3.1  3.9  2.3  2.3  2.2
5.5  7.5  8.3  6.6  6.0  4.0  3.0  2.7  3.3
6.3  7.5  9.0  8.3  8.7  9.2  9.2  7.6  7.4
9.1 11.3 14.4 14.3  9.8 10.0 12.6 13.2 12.4
5.9  7.3 10.6  8.7  8.8  7.1  6.9  4.2  4.0
6.7  7.9  9.6 10.6  8.7  9.6  8.1  6.4  5.9
1.6  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 
6.7  4.0  2.0  1.2  1.5  1.2  0.3  0.9  0.4
6.4  5.7  2.0  1.5  0.5  0.7  1.2  0.6  0.3
1.2  0.9  0.2  0.6  0.0  0.0  0.0  0.6  0.4
5.1  4.5  4.2  3.5  3.3  2.5  1.7  1.6  1.6
2.5  1.5  2.4  1.1  1.9  2.0  1.6  0.8  0.6
3.6  5.0  4.1  2.6  1.3  2.4  2.0  2.2  2.4 
4.3  5.0  6.6  3.1  2.2  2.8  2.5  1.7  1.2
7.5 10.6 12.0 13.5  9.6 11.5  9.2  7.6  7.7
6.5  8.1 11.0 10.7 10.0  9.7  7.9  7.4  5.2
7.1  9.2 10.4 11.7  7.9  8.4  4.7  4.2  3.5
3.6  6.6  9.9  8.8 11.5 12.0 12.0 11.3  9.7
3.6  3.7  2.8  2.0  1.5  0.0  1.2  1.6  0.5
2.6  1.4  1.3  1.0  1.6  0.4  0.0  0.3  0.6


dadosag <- data.frame(Subject=sub,x=x,y=y)
dadosag$Subject <- factor(dadosag$Subject)
dadosag$g <- 1
dadosag$g[dadosag$x==12] <- 2
dadosag$g[dadosag$x>=2&dadosag$x<=6] <- 2
dadosag$g[dadosag$x==8] <- 1
dadosag$g[dadosag$x==10] <- 1
dadosag$g <- factor(dadosag$g)
library(nlme)
dadosag <- groupedData(formula= y~ x|Subject, data=dadosag)

# Full mean model
m0 <- lme(y~factor(x), random=~1|Subject, data=dadosag, method="ML")


# MFP algorithm
source("MFP_function_With_RandomSlops.R", encoding = 'UTF-8')
mlmLin = lme(y ~ x, method = "ML", random = ~1|Subject, data=dadosag)
mlmNull = update(mlmLin, .~. -x)

RE = lmeStruct(reStruct(~1|Subject), corStruct=NULL, varStruct=varIdent())
MPF(fit1=mlmLin, fit2=mlmNull, covarx=dadosag$x, RE, RE)

# Model_selected: "FP2 Model"      "-0.5"      "-0.5" 

lmmFP2Step1 <- lme(y~I(x^(-0.5))+I(x^(-0.5)*log(x)), random=~1|Subject, 
                   data=dadosag, method="ML")

# Comparing to the full mean model for age
anova(m0,lmmFP2Step1)
pchisq(c(anova(m0,lmmFP2Step1)$"L.Ratio")[2], df=(11-7), lower.tail = FALSE)

lmmFP2Step1 = update(lmmFP2Step1, method="REML")
round(summary(lmmFP2Step1)$tTable, dig=3)
round(c(AIC(lmmFP2Step1), BIC(lmmFP2Step1), lmmFP2Step1$logLik), dig=2)
VarCorr(lmmFP2Step1) 

# ------------------------------------------------------------------------------
# Step 2: Selection of random effects structure
# ------------------------------------------------------------

# -------------------------------------------
# Fixed Effects Model F test
# -------------------------------------------

modfix = lm(y ~ I(x^(-0.5))+I(x^(-0.5)*log(x)), data=dadosag)

# Subject effect (Random intercept)
modb0 = lm(y ~ Subject + I(x^(-0.5))+I(x^(-0.5)*log(x)), data=dadosag)

Fanova = unlist(anova(modfix, modb0)[2,5:6])
# F            Pr(>F) 
# 3.817201e+01 1.758862e-215 

# Test F Demidenko
modfix = lm(y ~ I(x^(-0.5))+I(x^(-0.5)*log(x)), data=dadosag)

modrandom = lm(y ~ -1 + Subject, data=dadosag)
Fb0 = Ftest_Demidenko(modfix, modrandom, dadosag, dadosag$y)
# Fb0
# dfn           dfd            F_        pvalue 
# 8.800000e+01  7.100000e+02  3.817200e+01 1.758862e-215 

#-------------------------------------------------------------------------------
# Permutation tests
# Lee & Braun (2012)
# BLUP based permutation
# LR statistic based permutation
#-------------------------------------------------------------------------------
# The routine uses lme4 instead of nlme

library("lme4")
library(tidyverse)

set.seed(56575)
# Define the number of subjects and the number of observations per subject contained in dat.
numsub = nlevels(dadosag$Subject)

Nperms = 100
# ------------------------------------------------------------------------------
# inclusion of random Intercept (b0)
# ------------------------------------------------------------------------------

# Test for the intercept, only BLUP based permutation
# Fitting the alternative and null models.

fit0 = modfix
fit1 = lmer(y ~ I(x^(-0.5))+I(x^(-0.5)*log(x)) + (1|Subject),
            data=dadosag) 

randpart0 = "1" # not used
randpart1 = "(1|Subject)" 

controlMER = list(optimizer ='nloptwrap', optCtrl=list(method='NLOPT_LN_COBYLA', 
                                                       maxiter=100))

pValuesIntercept <- PermutationTest(Nperms, dadosag$y, positionranef=1, 
                                    numsub, fit0, fit1, randpart0, randpart1, 
                                    controlMER, dadosag)

# ------------------------------------------------------------------------------
# inclusion of random slop for I(x^(-0.5)) (b1)
# ------------------------------------------------------------------------------

# Fitting the alternative and null models.
fit0 = fit1
fit1 = lmer(y ~ I(x^(-0.5))+I(x^(-0.5)*log(x)) + (1+I(x^(-0.5))|Subject),
            data=dadosag) 

randpart0 = "(1|Subject)" 
randpart1 = "(1 + I(x^(-0.5))|Subject)" 
pValuesSlop1 <- PermutationTest(Nperms, dadosag$y, positionranef=2, 
                                numsub, fit0, fit1, randpart0, randpart1, 
                                controlMER, dadosag)

# ------------------------------------------------------------------------------
# inclusion of random slop for I(x^(-0.5)*log(x)) (b2)
# ------------------------------------------------------------------------------

# Fitting the alternative and null models.
fit0 = fit1
fit1 = lmer(y ~ I(x^(-0.5)) + I(x^(-0.5)*log(x)) + (1+I(x^(-0.5)) + 
                I(x^(-0.5)*log(x))|Subject),
                data=dadosag) 

randpart0 = "(1 + I(x^(-0.5))|Subject)" 
randpart1 = "(1 + I(x^(-0.5)) + I(x^(-0.5)*log(x))|Subject)" 
pValuesSlop2 <- PermutationTest(Nperms, dadosag$y, positionranef=3, 
                                numsub, fit0, fit1, randpart0, randpart1, 
                                controlMER, dadosag)

lmmFP2Step2 = lme(y ~ I(x^(-0.5)) + I(x^(-0.5)*log(x)), 
                  random= ~ 1 + I(x^(-0.5)) + I(x^(-0.5)*log(x))|Subject,
                  data=dadosag) 

round(summary(lmmFP2Step2)$tTable, dig=3)
round(c(AIC(lmmFP2Step2), BIC(lmmFP2Step2), lmmFP2Step2$logLik), dig=2)
VarCorr(lmmFP2Step2) 

# ------------------------------------------------------------------------------
# STEP 3: Variance structure for the random error
# ------------------------------------------------------------------------------

residStep2 = residdiag.nlme(fit=lmmFP2Step2,limit=2,plotid=1:6)

lmmFP2_h1 <- update(lmmFP2Step2, weights = varIdent(form=~1|g),  data=dadosag)
anova(lmmFP2Step2, lmmFP2_h1)
summary(lmmFP2_h1)

residStep3 = residdiag.nlme(fit=lmmFP2_h1,limit=2,plotid=1:6)

lmmFP2_h2 <- update(lmmFP2Step2, correlation=corAR1(form=~x), 
                    weights = varIdent(form=~1|g),  
                    control = lmeControl(opt =c("nlminb", "optim"), 
                                         optimMethod = "BFGS", 
                                         maxIter=1000, msMaxIter=1000, 
                                         niterEM=500, msMaxEval=1000))

anova(lmmFP2Step2, lmmFP2_h1, lmmFP2_h2)
summary(lmmFP2_h2)

residStep3h2 = residdiag.nlme(fit=lmmFP2_h2,limit=2,plotid=1:6)
# I think it is possible to improve the var-cov structure for this data
# but will leave as it is for the paper

lmmFP2Step3 = lmmFP2_h1

round(summary(lmmFP2Step3)$tTable, dig=3)
round(c(AIC(lmmFP2Step3), BIC(lmmFP2Step3), lmmFP2Step3$logLik), dig=2)
VarCorr(lmmFP2Step3)

#----------------------------------------------------------------------------------
# STEP 4: Once a reasonable structure for the variance-covariance is found,
# we go back to the mean model
#----------------------------------------------------------------------------------

lmmFP2_h1ML = update(lmmFP2Step3,  method = "ML")

mlmLin = update(lmmFP2_h1ML, fixed=y ~ x, 
                control=lmeControl(opt =c("nlminb", "optim"),
                optimMethod = "BFGS",
                maxIter=1000, msMaxIter=1000, 
                niterEM=500, msMaxEval=1000))

mlmNull = update(mlmLin, .~. -x, control = lmeControl(opt =c("nlminb", "optim"),
                                 optimMethod = "BFGS",
                                 maxIter=1000, msMaxIter=1000, 
                                 niterEM=500, msMaxEval=1000))

RE1 = lmeStruct(reStruct(~1+x1|Subject), corStruct=NULL, 
                varStruct=varIdent(form=~1|g))
RE2 = lmeStruct(reStruct(~1+x1+x2|Subject), corStruct=NULL,
                varStruct=varIdent(form=~1|g))
MPF(fit1=mlmLin, fit2=mlmNull, covarx=dadosag$x, RE1, RE2)

# Model_selected "FP2 Model"         "0"         "0" 

lmmFP2Step4 <- lme(y ~ I(log(x)) + I(log(x)^2), 
                   random=~1 + I(log(x)) + I(log(x)^2)|Subject, 
                   weights=varIdent(form=~1|g), data=dadosag, 
                   control=lmeControl(maxIter = 1000, msMaxIter = 500, 
                                      tolerance = 1e-6, 
                                      niterEM = 25,
                                      msMaxEval = 2000), method="REML")

round(summary(lmmFP2Step4)$tTable, dig=2)
round(c(AIC(lmmFP2Step4), BIC(lmmFP2Step4), lmmFP2Step4$logLik), dig=2)
VarCorr(lmmFP2Step4)

residStep4 = residdiag.nlme(fit=lmmFP2Step4,limit=2,plotid=1:6)

variance <- function(model)
{
  bili <- data.frame(y=1,x=seq(1,12, length=100))
  predm <- predict(model, level=0, bili)
  X <- model.matrix(model, bili)
  VF <- X %*% vcov(model) %*% t(X)
  delta <- model$modelStruct$varStruct[[1]]
  R <- diag((sigma(model)^2)*(bili$x^(2*delta)))
  Z <- model.matrix(formula(model$modelStruct$reStr)[[1]],data=bili)
  D <- getVarCov(model,type="random.effects")
  VRandom <- Z%*%D%*%t(Z)
  VM <- diag(VF+VRandom+R)
  se <- sqrt(VM)
  sePM <- sqrt(diag(VF+R))
  res <- data.frame(x=bili$x,predm=predm,se=se,sef=sqrt(diag(VF)), sePM=sePM)
  return(res)
}
# Variance pc2

library(ggplot2)
res1 <- variance(mod2R)
res2 <- variance(m0r)

medias <- data.frame(m=tappaly)
p0  = ggplot(dados, aes(x=x))+
  geom_ribbon(aes(ymin=predm-2*sef, ymax=predm+2*sef), data=res1,
              alpha=0.3,       #transparency
              linetype=1,      #solid, dashed or other line types
              colour="green", #border line color
              size=0,          #border line size
              fill="red") +    #fill color
  geom_ribbon(aes(ymin=predm-2*sef, ymax=predm+2*sef), data=res2,
              alpha=0.3,       #transparency
              linetype=1,      #solid, dashed or other line types
              colour="green", #border line color
              size=0,          #border line size
              fill="green") + 
  geom_line(aes(y=y, group=sub), color="grey55", size=.3, linetype=1) 
  

p1  = ggplot(dados, aes(x=x))+
  geom_ribbon(aes(ymin=predm-2*se, ymax=predm+2*se), data=res1,
              alpha=0.3,       #transparency
              linetype=1,      #solid, dashed or other line types
              colour="green", #border line color
              size=0,          #border line size
              fill="red") +    #fill color
  geom_ribbon(aes(ymin=predm-2*se, ymax=predm+2*se), data=res2,
              alpha=0.3,       #transparency
              linetype=1,      #solid, dashed or other line types
              colour="green", #border line color
              size=0,          #border line size
              fill="green") + 
  geom_line(aes(y=y, group=sub), color="grey55", size=.3, linetype=1) 


p2  = ggplot(dados, aes(x=x))+
  geom_ribbon(aes(ymin=predm-2*sePM, ymax=predm+2*sePM), data=res1,
              alpha=0.3,       #transparency
              linetype=1,      #solid, dashed or other line types
              colour="green", #border line color
              size=0,          #border line size
              fill="red") +    #fill color
  geom_ribbon(aes(ymin=predm-2*sePM, ymax=predm+2*sePM), data=res2,
              alpha=0.3,       #transparency
              linetype=1,      #solid, dashed or other line types
              colour="green", #border line color
              size=0,          #border line size
              fill="green") + 
  geom_line(aes(y=y, group=sub), color="grey55", size=.3, linetype=1) 



medias <- data.frame(m=tapply(dados$y,dados$x,mean), x=dados$x[dados$sub==1])
p0  = ggplot(medias, aes(x=x))+
  geom_ribbon(aes(ymin=predm-2*sef, ymax=predm+2*sef), data=res1,
              alpha=0.3,       #transparency
              linetype=1,      #solid, dashed or other line types
              colour="green", #border line color
              size=0,          #border line size
              fill="red")+
  geom_point(aes(y=m), color="red") 



 
